<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phuzzy Pack Promotion Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .header {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .promotion-card {
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .promotion-card.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .promotion-card.upcoming {
            border-color: #ed8936;
            background: #fffaf0;
        }
        
        .promotion-card.expired {
            border-color: #cbd5e0;
            background: #f7fafc;
            opacity: 0.7;
        }
        
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.active {
            background: #48bb78;
            color: white;
        }
        
        .status-badge.upcoming {
            background: #ed8936;
            color: white;
        }
        
        .status-badge.expired {
            background: #cbd5e0;
            color: #4a5568;
        }
        
        .pack-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .pack-item {
            background: #edf2f7;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pack-item.promoted {
            background: #e6fffa;
            border: 1px solid #38b2ac;
        }
        
        .tag {
            background: #e2e8f0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-block;
            margin: 2px;
        }
        
        .tag.required {
            background: #fed7d7;
            color: #c53030;
        }
        
        .tag.optional {
            background: #bee3f8;
            color: #2b6cb0;
        }
        
        .tag.excluded {
            background: #feebc8;
            color: #c05621;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #4a5568;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        button.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        button.secondary:hover {
            background: #cbd5e0;
        }
        
        .preview-section {
            background: #f7fafc;
            border: 1px dashed #cbd5e0;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .weight-display {
            font-weight: 600;
            color: #38a169;
        }
        
        .available-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .available-tags .tag {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .available-tags .tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Phuzzy Pack Promotion Manager</h1>
        <p>Configure which scenario packs are promoted for specific time periods and audiences</p>
    </div>
    
    <div class="section">
        <h2>üì¶ Available Packs</h2>
        <div id="pack-list" class="pack-list"></div>
    </div>
    
    <div class="section">
        <h2>üé™ Active Promotions</h2>
        <div id="promotions-list"></div>
        
        <button onclick="createNewPromotion()">+ Create New Promotion</button>
    </div>
    
    <div class="section">
        <h2>üé≤ Pack Selection Preview</h2>
        <p>See how packs will be selected with current promotions</p>
        <button onclick="runSelectionPreview()">Run 100 Simulations</button>
        <div id="preview-results" class="preview-section" style="display: none;"></div>
    </div>
    
    <div class="section" id="promotion-editor" style="display: none;">
        <h2>‚úèÔ∏è Edit Promotion</h2>
        <form id="promotion-form">
            <input type="hidden" id="promotion-id">
            
            <div class="form-group">
                <label>Promotion Name</label>
                <input type="text" id="promotion-name" required>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="promotion-description" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="promotion-start" required>
            </div>
            
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="promotion-end" required>
            </div>
            
            <div class="form-group">
                <label>Priority (0-100, higher = more important)</label>
                <input type="number" id="promotion-priority" min="0" max="100" value="50">
            </div>
            
            <div class="form-group">
                <label>Active</label>
                <select id="promotion-active">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Required Tags (packs must have ALL of these)</label>
                <input type="text" id="required-tags" placeholder="Enter tags separated by commas">
                <div class="available-tags" id="available-tags-required"></div>
            </div>
            
            <div class="form-group">
                <label>Optional Tags (bonus weight for these)</label>
                <input type="text" id="optional-tags" placeholder="Enter tags separated by commas">
                <div class="available-tags" id="available-tags-optional"></div>
            </div>
            
            <div class="form-group">
                <label>Excluded Tags (packs with these are excluded)</label>
                <input type="text" id="excluded-tags" placeholder="Enter tags separated by commas">
                <div class="available-tags" id="available-tags-excluded"></div>
            </div>
            
            <div class="form-group">
                <label>Pack-Specific Weights (multipliers)</label>
                <div id="pack-weights"></div>
            </div>
            
            <button type="submit">Save Promotion</button>
            <button type="button" class="secondary" onclick="cancelEdit()">Cancel</button>
        </form>
    </div>

    <script>
        // Load pack configuration
        let PACKS = {};
        let promotionData = null;
        let allTags = new Set();
        
        async function loadData() {
            // Load pack configuration
            try {
                // Try loading from file first
                const response = await fetch('./js/core/scenario-packs-config-enhanced.js');
                if (response.ok) {
                    const scriptText = await response.text();
                    eval(scriptText);
                    PACKS = window.SCENARIO_PACKS || {};
                }
            } catch (error) {
                console.error('Error loading pack config:', error);
            }
            
            // Collect all unique tags
            Object.values(PACKS).forEach(pack => {
                if (pack.tags) {
                    pack.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            // Load promotion data
            try {
                const response = await fetch('./data/pack-promotions.json');
                if (response.ok) {
                    promotionData = await response.json();
                } else {
                    promotionData = { promotions: [], defaultWeights: {} };
                }
            } catch (error) {
                console.error('Error loading promotions:', error);
                promotionData = { promotions: [], defaultWeights: {} };
            }
            
            renderPacks();
            renderPromotions();
        }
        
        function renderPacks() {
            const container = document.getElementById('pack-list');
            container.innerHTML = '';
            
            Object.values(PACKS).filter(pack => pack.enabled).forEach(pack => {
                const packEl = document.createElement('div');
                packEl.className = 'pack-item';
                packEl.innerHTML = `
                    <strong>${pack.name}</strong>
                    <span style="color: #718096; font-size: 12px;">(${pack.id})</span>
                    ${pack.tags ? pack.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                `;
                container.appendChild(packEl);
            });
        }
        
        function renderPromotions() {
            const container = document.getElementById('promotions-list');
            container.innerHTML = '';
            
            if (!promotionData || !promotionData.promotions) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            promotionData.promotions.forEach(promo => {
                const startDate = new Date(promo.startDate);
                const endDate = new Date(promo.endDate);
                endDate.setHours(23, 59, 59, 999);
                
                let status = 'expired';
                if (promo.active && today >= startDate && today <= endDate) {
                    status = 'active';
                } else if (promo.active && today < startDate) {
                    status = 'upcoming';
                }
                
                const promoEl = document.createElement('div');
                promoEl.className = `promotion-card ${status}`;
                promoEl.innerHTML = `
                    <span class="status-badge ${status}">${status.toUpperCase()}</span>
                    <h3>${promo.name}</h3>
                    <p style="color: #718096; margin: 5px 0;">${promo.description}</p>
                    <p style="font-size: 14px;">
                        <strong>Dates:</strong> ${promo.startDate} to ${promo.endDate}<br>
                        <strong>Priority:</strong> ${promo.priority}
                    </p>
                    ${promo.requiredTags?.length ? `<p><strong>Required:</strong> ${promo.requiredTags.map(tag => `<span class="tag required">${tag}</span>`).join('')}</p>` : ''}
                    ${promo.optionalTags?.length ? `<p><strong>Optional:</strong> ${promo.optionalTags.map(tag => `<span class="tag optional">${tag}</span>`).join('')}</p>` : ''}
                    ${promo.excludeTags?.length ? `<p><strong>Excluded:</strong> ${promo.excludeTags.map(tag => `<span class="tag excluded">${tag}</span>`).join('')}</p>` : ''}
                    <button onclick="editPromotion('${promo.id}')">Edit</button>
                    <button class="secondary" onclick="deletePromotion('${promo.id}')">Delete</button>
                `;
                container.appendChild(promoEl);
            });
        }
        
        function createNewPromotion() {
            const newPromo = {
                id: `promo-${Date.now()}`,
                name: 'New Promotion',
                description: '',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                active: true,
                priority: 50,
                requiredTags: [],
                optionalTags: [],
                excludeTags: [],
                packWeights: {}
            };
            
            editPromotion(newPromo.id, newPromo);
        }
        
        function editPromotion(promoId, newPromo = null) {
            const promo = newPromo || promotionData.promotions.find(p => p.id === promoId);
            if (!promo && !newPromo) return;
            
            document.getElementById('promotion-editor').style.display = 'block';
            document.getElementById('promotion-id').value = promo.id;
            document.getElementById('promotion-name').value = promo.name;
            document.getElementById('promotion-description').value = promo.description || '';
            document.getElementById('promotion-start').value = promo.startDate;
            document.getElementById('promotion-end').value = promo.endDate;
            document.getElementById('promotion-priority').value = promo.priority || 50;
            document.getElementById('promotion-active').value = promo.active ? 'true' : 'false';
            document.getElementById('required-tags').value = (promo.requiredTags || []).join(', ');
            document.getElementById('optional-tags').value = (promo.optionalTags || []).join(', ');
            document.getElementById('excluded-tags').value = (promo.excludeTags || []).join(', ');
            
            // Show available tags
            showAvailableTags();
            
            // Show pack weights
            const weightsContainer = document.getElementById('pack-weights');
            weightsContainer.innerHTML = '';
            
            Object.values(PACKS).filter(pack => pack.enabled).forEach(pack => {
                const weight = promo.packWeights?.[pack.id] || 1;
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <label style="display: inline-block; width: 300px;">${pack.name}:</label>
                    <input type="number" id="weight-${pack.id}" value="${weight}" min="0" max="10" step="0.5" style="width: 80px;">
                    <span style="color: #718096; margin-left: 10px;">Default: 1</span>
                `;
                weightsContainer.appendChild(div);
            });
        }
        
        function showAvailableTags() {
            const containers = {
                'available-tags-required': document.getElementById('available-tags-required'),
                'available-tags-optional': document.getElementById('available-tags-optional'),
                'available-tags-excluded': document.getElementById('available-tags-excluded')
            };
            
            Object.entries(containers).forEach(([id, container]) => {
                container.innerHTML = '<small style="color: #718096;">Click tags to add: </small>';
                Array.from(allTags).sort().forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.textContent = tag;
                    tagEl.onclick = () => addTagToInput(id.replace('available-tags-', ''), tag);
                    container.appendChild(tagEl);
                });
            });
        }
        
        function addTagToInput(inputType, tag) {
            const input = document.getElementById(`${inputType}-tags`);
            const currentTags = input.value.split(',').map(t => t.trim()).filter(t => t);
            if (!currentTags.includes(tag)) {
                currentTags.push(tag);
                input.value = currentTags.join(', ');
            }
        }
        
        function cancelEdit() {
            document.getElementById('promotion-editor').style.display = 'none';
        }
        
        async function savePromotion(event) {
            event.preventDefault();
            
            const promoId = document.getElementById('promotion-id').value;
            const promo = {
                id: promoId,
                name: document.getElementById('promotion-name').value,
                description: document.getElementById('promotion-description').value,
                startDate: document.getElementById('promotion-start').value,
                endDate: document.getElementById('promotion-end').value,
                priority: parseInt(document.getElementById('promotion-priority').value),
                active: document.getElementById('promotion-active').value === 'true',
                requiredTags: document.getElementById('required-tags').value.split(',').map(t => t.trim()).filter(t => t),
                optionalTags: document.getElementById('optional-tags').value.split(',').map(t => t.trim()).filter(t => t),
                excludeTags: document.getElementById('excluded-tags').value.split(',').map(t => t.trim()).filter(t => t),
                packWeights: {}
            };
            
            // Collect pack weights
            Object.values(PACKS).filter(pack => pack.enabled).forEach(pack => {
                const weightInput = document.getElementById(`weight-${pack.id}`);
                if (weightInput) {
                    const weight = parseFloat(weightInput.value);
                    if (weight !== 1) {
                        promo.packWeights[pack.id] = weight;
                    }
                }
            });
            
            // Update or add promotion
            const existingIndex = promotionData.promotions.findIndex(p => p.id === promoId);
            if (existingIndex >= 0) {
                promotionData.promotions[existingIndex] = promo;
            } else {
                promotionData.promotions.push(promo);
            }
            
            // Save to file
            await savePromotionData();
            
            // Hide editor and refresh
            cancelEdit();
            renderPromotions();
        }
        
        async function deletePromotion(promoId) {
            if (!confirm('Are you sure you want to delete this promotion?')) return;
            
            promotionData.promotions = promotionData.promotions.filter(p => p.id !== promoId);
            await savePromotionData();
            renderPromotions();
        }
        
        async function savePromotionData() {
            // In a real implementation, this would save to the server
            // For now, we'll just show the JSON to copy
            const json = JSON.stringify(promotionData, null, 2);
            console.log('Save this to data/pack-promotions.json:');
            console.log(json);
            
            // Create download link
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pack-promotions.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Promotion data downloaded! Copy it to data/pack-promotions.json');
        }
        
        async function runSelectionPreview() {
            const resultsEl = document.getElementById('preview-results');
            resultsEl.style.display = 'block';
            resultsEl.innerHTML = '<p>Running simulation...</p>';
            
            // Load the enhanced config
            await loadData();
            
            // Run simulation
            const counts = {};
            const iterations = 100;
            
            // Simulate pack selection
            for (let i = 0; i < iterations; i++) {
                const pack = simulatePackSelection();
                counts[pack.id] = (counts[pack.id] || 0) + 1;
            }
            
            // Display results
            resultsEl.innerHTML = '<h3>Simulation Results (100 selections)</h3>';
            
            const sortedResults = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .map(([packId, count]) => {
                    const pack = PACKS[packId];
                    return `
                        <div style="margin-bottom: 10px;">
                            <strong>${pack.name}</strong>: 
                            <span class="weight-display">${count}%</span>
                            <div style="font-size: 12px; color: #718096;">
                                Tags: ${pack.tags?.join(', ') || 'none'}
                            </div>
                        </div>
                    `;
                });
            
            resultsEl.innerHTML += sortedResults.join('');
        }
        
        function simulatePackSelection() {
            const availablePacks = Object.values(PACKS).filter(pack => pack.enabled);
            
            // Calculate weights
            const weights = {};
            availablePacks.forEach(pack => {
                weights[pack.id] = promotionData?.defaultWeights?.[pack.id] || 1;
            });
            
            // Apply active promotions
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const activePromotions = promotionData.promotions.filter(promo => {
                if (!promo.active) return false;
                const startDate = new Date(promo.startDate);
                const endDate = new Date(promo.endDate);
                endDate.setHours(23, 59, 59, 999);
                return today >= startDate && today <= endDate;
            }).sort((a, b) => (b.priority || 0) - (a.priority || 0));
            
            activePromotions.forEach(promotion => {
                // Apply specific pack weights
                if (promotion.packWeights) {
                    Object.entries(promotion.packWeights).forEach(([packId, weight]) => {
                        if (weights[packId] !== undefined) {
                            weights[packId] *= weight;
                        }
                    });
                }
                
                // Apply tag-based weights
                availablePacks.forEach(pack => {
                    if (packMatchesPromotion(pack, promotion)) {
                        weights[pack.id] *= 2;
                        
                        // Extra boost for optional tags
                        if (promotion.optionalTags && pack.tags) {
                            const optionalMatches = promotion.optionalTags.filter(tag => 
                                pack.tags.includes(tag)
                            ).length;
                            weights[pack.id] *= (1 + optionalMatches * 0.5);
                        }
                    }
                });
            });
            
            // Weighted random selection
            const totalWeight = Object.values(weights).reduce((sum, w) => sum + w, 0);
            let random = Math.random() * totalWeight;
            
            for (const pack of availablePacks) {
                random -= weights[pack.id];
                if (random <= 0) {
                    return pack;
                }
            }
            
            return availablePacks[0];
        }
        
        function packMatchesPromotion(pack, promotion) {
            if (!pack.tags) return false;
            
            // Check required tags
            if (promotion.requiredTags && promotion.requiredTags.length > 0) {
                const hasAllRequired = promotion.requiredTags.every(tag => pack.tags.includes(tag));
                if (!hasAllRequired) return false;
            }
            
            // Check excluded tags
            if (promotion.excludeTags && promotion.excludeTags.length > 0) {
                const hasExcluded = promotion.excludeTags.some(tag => pack.tags.includes(tag));
                if (hasExcluded) return false;
            }
            
            return true;
        }
        
        // Set up form submission
        document.getElementById('promotion-form').addEventListener('submit', savePromotion);
        
        // Load data on startup
        loadData();
    </script>
</body>
</html>